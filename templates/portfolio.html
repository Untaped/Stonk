<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulated Portfolio - Strategy AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            --secondary-gradient: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            --success-gradient: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            --warning-gradient: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
            --danger-gradient: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --card-bg: rgba(26, 32, 44, 0.85);
            --card-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 50%, #2d3748 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(74, 85, 104, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(113, 128, 150, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(45, 55, 72, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .gradient-text {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar {
            background: rgba(26, 32, 44, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover::before {
            left: 0;
        }

        .form-input {
            background: rgba(26, 32, 44, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            background: rgba(26, 32, 44, 0.9);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 20px rgba(74, 85, 104, 0.3);
            outline: none;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(74, 85, 104, 0.4);
        }

        .btn-secondary {
            background: var(--success-gradient);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(56, 161, 105, 0.4);
        }

        .btn-remove {
            background: var(--danger-gradient);
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-remove:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(229, 62, 62, 0.4);
        }

        .data-table {
            background: transparent;
            overflow: hidden;
        }

        .table-header {
            background: rgba(26, 32, 44, 0.9);
            backdrop-filter: blur(10px);
        }

        .table-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .table-row:hover {
            background: rgba(255, 255, 255, 0.03);
            transform: translateX(2px);
        }

        .table-footer {
            background: rgba(26, 32, 44, 0.9);
            backdrop-filter: blur(10px);
        }

        .chart-container {
            background: rgba(26, 32, 44, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .floating-orb {
            position: fixed;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 6s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        .floating-orb:nth-child(1) {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .floating-orb:nth-child(2) {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            top: 70%;
            right: 10%;
            animation-delay: 2s;
        }

        .floating-orb:nth-child(3) {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            top: 40%;
            left: 70%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(120deg); }
            66% { transform: translateY(-10px) rotate(240deg); }
        }

        .metric-value {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .positive-growth {
            color: #38a169;
        }

        .negative-growth {
            color: #e53e3e;
        }

        .stock-input-group {
            opacity: 0;
            transform: translateY(-10px);
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateY(0);
                max-height: 200px;
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
                margin: 0;
                padding: 0;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-gradient);
        }

        @media (max-width: 768px) {
            .floating-orb {
                display: none;
            }
        }
    </style>
</head>
<body class="text-white">
    <!-- Floating Orbs -->
    <div class="floating-orb"></div>
    <div class="floating-orb"></div>
    <div class="floating-orb"></div>

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-full md:w-64 p-6 shadow-2xl flex flex-col justify-between relative z-10">
            <div>
                <h1 class="text-3xl font-black mb-8 gradient-text">
                    <i class="fas fa-chart-line mr-2"></i>Litlguy.inc
                </h1>
                <nav class="space-y-3">
                    <a href="/" class="nav-item block py-4 px-4 rounded-xl transition-all duration-300 hover:text-white relative z-10">
                        <i class="fas fa-home mr-3"></i>Dashboard
                    </a>
                    <a href="/sp500" class="nav-item block py-4 px-4 rounded-xl transition-all duration-300 hover:text-white relative z-10">
                        <i class="fas fa-chart-bar mr-3"></i>Top S&P 500
                    </a>
                    <a href="/portfolio" class="nav-item block py-4 px-4 rounded-xl transition-all duration-300 hover:text-white relative z-10 bg-gray-700">
                        <i class="fas fa-briefcase mr-3"></i>Portfolio
                    </a>
                </nav>
            </div>
            <div class="mt-10">
                <div class="glass-card rounded-xl p-4 mb-4">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-robot text-green-400 mr-2"></i>
                        <span class="text-sm font-medium">AI Status</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                        <span class="text-xs text-gray-300">Online & Learning</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 space-y-8 overflow-y-auto relative z-10">
            <!-- Header -->
            <div class="glass-card rounded-2xl p-8 text-center">
                <h2 class="text-4xl font-black mb-4 gradient-text">
                    <i class="fas fa-chart-pie mr-3"></i>Portfolio Simulator
                </h2>
                <p class="text-xl text-gray-200 mb-4 max-w-3xl mx-auto">
                    Simulate your investment strategy with historical data and track performance
                </p>
            </div>

            <!-- Input Section -->
            <section class="glass-card rounded-2xl shadow-xl p-8">
                <h3 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-edit mr-3 text-gray-400"></i>Portfolio Setup
                </h3>
                <form method="POST" class="space-y-6">
                    <p class="text-gray-300 mb-6">Enter stock symbols and investment amounts (USD):</p>
                    
                    <div id="stockInputContainer" class="space-y-4">
                        <!-- Initial stock inputs will be added here by JavaScript -->
                    </div>

                    <div class="flex justify-between items-center mt-6">
                        <button 
                            type="button" 
                            id="addStockBtn" 
                            class="btn-secondary px-6 py-3 rounded-xl text-base font-semibold text-white flex items-center"
                        >
                            <i class="fas fa-plus mr-2"></i>Add Another Stock
                        </button>
                        <div class="text-sm text-gray-400">
                            <span id="stockCount">2</span>/10 stocks
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button type="submit" class="btn-primary px-8 py-4 rounded-xl text-lg font-bold text-white relative overflow-hidden">
                            <i class="fas fa-calculator mr-2"></i>Simulate Portfolio
                        </button>
                    </div>
                </form>
            </section>

            {% if results %}
            <!-- Results Section -->
            <section class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <!-- Results Table -->
                <div class="glass-card rounded-2xl shadow-xl p-6">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-table mr-3 text-gray-400"></i>Simulation Results
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="data-table w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="py-4 px-4 text-left text-sm font-semibold text-gray-200 uppercase tracking-wider">
                                        <i class="fas fa-tag mr-2"></i>Symbol
                                    </th>
                                    <th class="py-4 px-4 text-right text-sm font-semibold text-gray-200 uppercase tracking-wider">
                                        Initial ($)
                                    </th>
                                    <th class="py-4 px-4 text-right text-sm font-semibold text-gray-200 uppercase tracking-wider">
                                        Final ($)
                                    </th>
                                    <th class="py-4 px-4 text-right text-sm font-semibold text-gray-200 uppercase tracking-wider">
                                        Invested ($)
                                    </th>
                                    <th class="py-4 px-4 text-right text-sm font-semibold text-gray-200 uppercase tracking-wider">
                                        Value ($)
                                    </th>
                                    <th class="py-4 px-4 text-right text-sm font-semibold text-gray-200 uppercase tracking-wider">
                                        Growth (%)
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700/50">
                                {% for r in results %}
                                <tr class="table-row">
                                    <td class="py-4 px-4">
                                        <span class="font-mono font-bold text-lg text-white">{{ r.symbol }}</span>
                                    </td>
                                    <td class="py-4 px-4 text-right text-gray-300 font-medium">{{ r.start_price }}</td>
                                    <td class="py-4 px-4 text-right text-gray-300 font-medium">{{ r.end_price }}</td>
                                    <td class="py-4 px-4 text-right text-white font-semibold">${{ '%.2f'|format(r.amount) }}</td>
                                    <td class="py-4 px-4 text-right text-white font-semibold">${{ r.final_value }}</td>
                                    <td class="py-4 px-4 text-right font-bold">
                                        {% set growth = ((r.final_value - r.amount) / r.amount) * 100 %}
                                        {% if growth >= 0 %}
                                            <span class="positive-growth">+{{ '%.2f'|format(growth) }}%</span>
                                        {% else %}
                                            <span class="negative-growth">{{ '%.2f'|format(growth) }}%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-footer">
                                <tr class="font-bold">
                                    <td class="py-4 px-4 text-left text-white">
                                        <i class="fas fa-calculator mr-2"></i>TOTAL
                                    </td>
                                    <td colspan="3" class="py-4 px-4"></td>
                                    <td class="py-4 px-4 text-right text-xl metric-value">${{ total_final }}</td>
                                    <td class="py-4 px-4 text-right text-xl font-black">
                                        {% set total_growth = ((total_final - total_initial) / total_initial) * 100 %}
                                        {% if total_growth >= 0 %}
                                            <span class="positive-growth">+{{ '%.2f'|format(total_growth) }}%</span>
                                        {% else %}
                                            <span class="negative-growth">{{ '%.2f'|format(total_growth) }}%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="glass-card rounded-2xl shadow-xl p-6 flex flex-col">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-gray-400"></i>Portfolio Performance
                    </h3>
                    <div class="chart-container relative flex-1 min-h-[400px] p-4">
                        <canvas id="portfolioChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>

            <!-- Portfolio Summary -->
            <div class="glass-card rounded-2xl p-8">
                <h3 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-gray-400"></i>Portfolio Summary
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-6 rounded-xl bg-gray-800/30">
                        <div class="text-3xl font-black mb-2 metric-value">
                            ${{ '%.2f'|format(total_initial) }}
                        </div>
                        <p class="text-sm text-gray-400 uppercase tracking-wide">Initial Investment</p>
                    </div>
                    <div class="text-center p-6 rounded-xl bg-gray-800/30">
                        <div class="text-3xl font-black mb-2 metric-value">
                            ${{ total_final }}
                        </div>
                        <p class="text-sm text-gray-400 uppercase tracking-wide">Current Value</p>
                    </div>
                    <div class="text-center p-6 rounded-xl bg-gray-800/30">
                        <div class="text-3xl font-black mb-2">
                            {% set total_growth = ((total_final - total_initial) / total_initial) * 100 %}
                            {% if total_growth >= 0 %}
                                <span class="positive-growth">+${{ '%.2f'|format(total_final - total_initial) }}</span>
                            {% else %}
                                <span class="negative-growth">-${{ '%.2f'|format(total_initial - total_final) }}</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-400 uppercase tracking-wide">Total Gain/Loss</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Footer -->
            <div class="glass-card rounded-xl p-6 text-center">
                <p class="text-sm text-gray-400 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>
                    Portfolio simulation based on historical price data
                </p>
                <p class="text-xs text-gray-500">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    This is not financial advice. Past performance does not guarantee future results.
                </p>
            </div>
        </main>
    </div>

    {% if results %}
    <script>
        const ctx = document.getElementById('portfolioChart').getContext('2d');
        const datasets = [
            {% for r in results %}
            {
                label: '{{ r.symbol }}',
                data: [],
                borderColor: getRandomColor(),
                backgroundColor: 'transparent',
                fill: false,
                tension: 0.3,
                pointRadius: 0,
                borderWidth: 2,
            },
            {% endfor %}
        ];

        async function fetchPriceHistory(symbol) {
            try {
                const resp = await fetch(`/api/price_history/${symbol}`);
                if (!resp.ok) return null;
                const data = await resp.json();
                return data.prices;
            } catch (error) {
                console.error(`Error fetching data for ${symbol}:`, error);
                return null;
            }
        }

        async function plotPortfolio() {
            const promises = datasets.map(ds => fetchPriceHistory(ds.label));
            const allPrices = await Promise.all(promises);

            allPrices.forEach((prices, i) => {
                if (prices && prices.length) {
                    const start = prices[0];
                    datasets[i].data = prices.map(p => (p / start) * 100);
                }
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(Math.max(...datasets.map(d => d.data.length))).fill('').map((_, i) => i + 1),
                    datasets: datasets.filter(d => d.data.length > 0)
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                usePointStyle: true,
                                pointStyle: 'line'
                            }
                        },
                        title: { 
                            display: true, 
                            text: 'Normalized Price History (Last 2 Years)',
                            color: 'rgba(255, 255, 255, 0.9)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 10
                        }
                    },
                    scales: {
                        y: { 
                            title: { 
                                display: true, 
                                text: 'Normalized Price (%)',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: { 
                            display: false 
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });
        }

        function getRandomColor() {
            const colors = [
                '#38a169', '#d69e2e', '#e53e3e', '#3182ce', '#805ad5',
                '#dd6b20', '#38b2ac', '#d53f8c', '#319795', '#4299e1'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        plotPortfolio();
    </script>
    {% endif %}

    <script>
        let stockCount = 0;
        const maxStocks = 10;

        function createStockInput(index) {
            const div = document.createElement('div');
            div.className = 'stock-input-group flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 items-center';
            div.innerHTML = `
                <div class="w-full md:flex-1">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Stock Symbol</label>
                    <input 
                        type="text" 
                        name="symbol${index}" 
                        placeholder="e.g. AAPL" 
                        class="form-input w-full px-4 py-3 rounded-xl text-lg uppercase"
                        maxlength="5" 
                    />
                </div>
                <div class="w-full md:w-40">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Amount ($)</label>
                    <input 
                        type="number" 
                        name="amount${index}" 
                        min="0" 
                        step="0.01" 
                        placeholder="1000" 
                        class="form-input w-full px-4 py-3 rounded-xl text-lg"
                    />
                </div>
                ${index > 1 ? `
                <div class="w-full md:w-auto mt-2 md:mt-6">
                    <button 
                        type="button" 
                        class="btn-remove px-4 py-3 rounded-xl text-white font-medium w-full md:w-auto"
                        onclick="removeStockInput(this)"
                    >
                        <i class="fas fa-trash mr-2"></i>Remove
                    </button>
                </div>
                ` : ''}
            `;
            return div;
        }

        function addStockInput() {
            if (stockCount >= maxStocks) return;
            
            const container = document.getElementById('stockInputContainer');
            const newInput = createStockInput(stockCount);
            container.appendChild(newInput);
            stockCount++;
            updateUI();
        }

        function removeStockInput(button) {
            if (stockCount <= 2) return; // Don't remove if only 2 stocks left
            
            const inputGroup = button.closest('.stock-input-group');
            inputGroup.style.animation = 'slideOut 0.3s ease-in forwards';
            
            setTimeout(() => {
                inputGroup.remove();
                stockCount--;
                updateUI();
                reindexInputs();
            }, 300);
        }

        function reindexInputs() {
            const inputs = document.querySelectorAll('#stockInputContainer .stock-input-group');
            inputs.forEach((group, index) => {
                const symbolInput = group.querySelector('input[name^="symbol"]');
                const amountInput = group.querySelector('input[name^="amount"]');
                
                symbolInput.name = `symbol${index}`;
                amountInput.name = `amount${index}`;
            });
        }

        function updateUI() {
            const addBtn = document.getElementById('addStockBtn');
            const countSpan = document.getElementById('stockCount');
            
            countSpan.textContent = stockCount;
            
            if (stockCount >= maxStocks) {
                addBtn.style.opacity = '0.5';
                addBtn.disabled = true;
            } else {
                addBtn.style.opacity = '1';
                addBtn.disabled = false;
            }
        }

        // Initialize with 2 stock inputs
        document.addEventListener('DOMContentLoaded', function() {
            for (let i = 0; i < 2; i++) {
                addStockInput();
            }
            
            // Add event listener to add stock button
            document.getElementById('addStockBtn').addEventListener('click', addStockInput);
        });
    </script>
</body>
</html>