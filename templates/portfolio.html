<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulated Portfolio - Stock Strategy Advisor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .modal-transition {
      transition: opacity 0.3s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">
  <div class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-gray-800 text-white p-6 shadow-md flex flex-col justify-between">
      <div>
        <h1 class="text-2xl font-bold mb-6">üìà Strategy Advisor</h1>
        <nav class="space-y-4">
          <a href="/" class="block py-2 px-3 rounded hover:bg-gray-700">üè† Home</a>
          <a href="/sp500" class="block py-2 px-3 rounded hover:bg-gray-700">üìä Top S&P</a>
          <a href="/portfolio" class="block py-2 px-3 rounded hover:bg-gray-700">üìÅ Simulated Portfolio</a>
        </nav>
        <button id="openSettings" class="mt-4 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded w-full">
          ‚öôÔ∏è Settings
        </button>
      </div>
      <p class="text-sm text-gray-400 mt-10 hidden md:block">&copy; 2025</p>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 space-y-10 overflow-y-auto">
      <!-- Input Cube -->
      <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 text-center">üìÅ Portfolio Simulator</h2>
        <form method="POST" class="space-y-4">
          <p>Enter up to 5 stock symbols and investment amounts (USD):</p>
          {% for i in range(5) %}
          <div class="flex space-x-4 items-center">
            <input type="text" name="symbol{{ i }}" placeholder="Symbol e.g. AAPL" class="border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-black dark:text-white rounded px-3 py-2 flex-grow" maxlength="5" />
            <input type="number" name="amount{{ i }}" min="0" step="0.01" placeholder="Amount $" class="border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-black dark:text-white rounded px-3 py-2 w-32" />
          </div>
          {% endfor %}
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded mt-4">
            Simulate Portfolio
          </button>
        </form>
      </section>

      {% if results %}
      <!-- Results and Chart Section Side by Side -->
      <section class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <!-- Results Cube -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
          <h2 class="text-xl font-semibold mb-6">üìä Simulation Results</h2>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead class="bg-gray-200 dark:bg-gray-700">
                <tr>
                  <th class="border px-4 py-2 text-left">Symbol</th>
                  <th class="border px-4 py-2 text-right">Initial Price ($)</th>
                  <th class="border px-4 py-2 text-right">Final Price ($)</th>
                  <th class="border px-4 py-2 text-right">Amount Invested ($)</th>
                  <th class="border px-4 py-2 text-right">Final Value ($)</th>
                  <th class="border px-4 py-2 text-right">% Growth</th>
                </tr>
              </thead>
              <tbody>
                {% for r in results %}
                <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                  <td class="border px-4 py-2">{{ r.symbol }}</td>
                  <td class="border px-4 py-2 text-right">{{ r.start_price }}</td>
                  <td class="border px-4 py-2 text-right">{{ r.end_price }}</td>
                  <td class="border px-4 py-2 text-right">{{ '%.2f'|format(r.amount) }}</td>
                  <td class="border px-4 py-2 text-right">{{ r.final_value }}</td>
                  <td class="border px-4 py-2 text-right">{{ '%.2f'|format(((r.final_value - r.amount) / r.amount) * 100) }}%</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="bg-gray-100 dark:bg-gray-700 font-semibold">
                <tr>
                  <td class="border px-4 py-2 text-left">TOTAL</td>
                  <td colspan="3" class="border px-4 py-2"></td>
                  <td class="border px-4 py-2 text-right">{{ total_final }}</td>
                  <td class="border px-4 py-2 text-right">{{ '%.2f'|format(((total_final - total_initial) / total_initial) * 100) }}%</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Chart Cube -->
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 flex flex-col">
        <h2 class="text-xl font-semibold mb-4">üìà Portfolio Chart (Normalized Price History)</h2>
        <div class="relative flex-1 min-h-[400px]">
            <canvas id="portfolioChart" class="w-full h-full"></canvas>
        </div>
        </section>

      {% endif %}
    </main>
  </div>

  {% if results %}
  <script>
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    const datasets = [
      {% for r in results %}
      {
        label: '{{ r.symbol }}',
        data: [],
        borderColor: getRandomColor(),
        fill: false,
        tension: 0.3,
        pointRadius: 0,
      },
      {% endfor %}
    ];

    async function fetchPriceHistory(symbol) {
      const resp = await fetch(`/api/price_history/${symbol}`);
      if (!resp.ok) return null;
      const data = await resp.json();
      return data.prices;
    }

    async function plotPortfolio() {
      const promises = datasets.map(ds => fetchPriceHistory(ds.label));
      const allPrices = await Promise.all(promises);

      allPrices.forEach((prices, i) => {
        if (prices && prices.length) {
          const start = prices[0];
          datasets[i].data = prices.map(p => (p / start) * 100);
        }
      });

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array(datasets[0].data.length).fill('').map((_, i) => i + 1),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Normalized Price History (Last 2 Years)' }
          },
          scales: {
            y: { title: { display: true, text: 'Normalized Price (%)' }},
            x: { display: false }
          }
        }
      });
    }

    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    plotPortfolio();
  </script>
  {% endif %}
</body>
</html>